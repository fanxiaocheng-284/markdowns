# 关于socket顶替登陆

> 需求背景 由于切换了服务体系，由标准websocket切换为各大IM服务商都支持的MQTT方式，原有的replace（即顶替）方法不再支持，需要另寻方式支持。

## 卡点

* 顶替顺序问题，要持续保证后连接socket消息的用户能顶替之前连接socket消息的用户。
* 因为令牌桶机制，socket虽是广播消息，但由于网络问题与消息本身不为必须到达信令，各端在消息到达时间上会有差异。
* 顶替登陆为两个独立个体，且在连接上websocket时每一端都会主动发出当前用户的online消息且在服务端收到消息后广播，如何甄别该消息是自身发出还是另一个顶替身份发出并在被顶替一方作出登出操作。
* online消息发出后如果顺利执行顶替操作，那么在前一名被顶替之前会有同一用户两地登陆的状态，然后前一名用户登出，服务端在收到登出操作后会迅速广播一条该用户offline的消息，如何让后一名用户不受offline消息的影响而执行登出操作；且在其它用户的学员列表界面中不受该offline消息的影响而使该用户显示持续在线。


## 相应措施

* 针对连接socket顺序问题和信令到达时间差异问题：需要通过在连接socket时保存当前时间戳的方式对时间点进行保存。且在online消息发送时一并发出，并在收到消息后以此为参照，而不是以服务端时间为参照。
* 针对同一账号信息两端使用的信令甄别： 因为需要判断连接socket的时间先后，所以需要保证上条时间戳的精度足以保证在绝大多数情况下两个不同位置的连接操作时间设置不一致，所以时间戳选用毫秒为单位
* 针对offline消息的规避：因为现还未有老师将学员掉线的操作，所以在收到自身掉线的广播一并补发一条自身的online消息以告知所有人在线。即整个顶替流程其他人会收到online->online->offline->online四条消息，即结果还是online。